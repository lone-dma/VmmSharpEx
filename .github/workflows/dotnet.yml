name: Publish Package to NuGet

on:
  push:
    branches:
      - master
    paths:
      - 'src/VmmSharpEx/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-build:
    if: github.repository_owner == 'lone-dma'
    runs-on: windows-latest
    environment: production
    permissions:
      id-token: write

    steps:
      - name: Send Discord Webhook
        shell: pwsh
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          JOB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          $payload = @{
              username = "GitHub Actions"
              embeds = @(
              @{
                  title = "$env:REPO"
                  description = "ðŸš€ Build started"
                  color = 5814783
                  fields = @(
                  @{
                      name  = "Job Link"
                      value = $env:JOB_URL
                  }
                  )
              }
              )
          } | ConvertTo-Json -Depth 5
          Invoke-RestMethod -Uri $env:WEBHOOK -Method Post -ContentType "application/json" -Body $payload
          
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup .NET SDKs
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Run Tests
        run: |
          mkdir -p artifacts
          dotnet test src/VmmSharpEx_Tests/VmmSharpEx_Tests.csproj --logger "console;verbosity=detailed" | tee artifacts/test-output.txt

      - name: Get version info
        uses: dotnet/nbgv@master
        id: nbgv

      - name: Pack NuGet (Release)
        run: |
          dotnet pack src/VmmSharpEx/VmmSharpEx.csproj `
            -c Release `
            -p:ContinuousIntegrationBuild=true `
            -p:Version=${{ steps.nbgv.outputs.NuGetPackageVersion }} `
            -p:AssemblyVersion=${{ steps.nbgv.outputs.AssemblyVersion }} `
            -p:FileVersion=${{ steps.nbgv.outputs.AssemblyFileVersion }} `
            -o artifacts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: artifacts/*

  publish:
    runs-on: windows-latest
    environment: production
    needs: test-build
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: artifacts

      - name: Get version info
        uses: dotnet/nbgv@master
        id: nbgv

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.nbgv.outputs.SemVer2 }}" `
            --title "VmmSharpEx ${{ steps.nbgv.outputs.SemVer2 }}" `
            --notes "Available at https://www.nuget.org/packages/VmmSharpEx" `
            artifacts/test-output.txt

      - name: NuGet Login
        uses: NuGet/login@v1
        id: login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: NuGet Push
        run: dotnet nuget push "artifacts/**/*.nupkg" --api-key ${{steps.login.outputs.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json
